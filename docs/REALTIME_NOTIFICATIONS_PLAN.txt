Realtime & Notification Enhancements Plan
=========================================

Context
-------
- Goal: deliver web push for challenges/streaks, optional email digests, and client-side subscription management built on existing `/api/notifications` routes.
- Timeframe: Week 3–5 initiative as outlined in roadmap.
- Dependencies: Stable middleware instrumentation, access to environment secrets, email service provider (e.g., SendGrid/Postmark), background task runner.

Task Tracker
------------
Legend — Priority: (C) Critical, (H) High, (M) Medium, (L) Low

1. Research & Platform Decisions (C) — ✅ Completed Feb 2025
   1.1 Confirm push strategy (native Web Push w/ VAPID vs. third-party) and target browsers.
   1.2 Choose email provider for digests; confirm template tooling and rate limits.
   1.3 Document consent/opt-out requirements (GDPR, CAN-SPAM) and storage expectations.
   Deliverable: Decision memo in `docs/NOTIFICATIONS_PUSH.md`.

2. Push Infrastructure Foundations (C) — ✅ Completed Feb 2025
   2.1 Generate VAPID keys; store as secrets (`PUSH_PUBLIC_KEY`, `PUSH_PRIVATE_KEY`) and add to env templates.
   2.2 Extend Prisma schema: create `PushSubscription` model linked to user with endpoint, keys, meta, and opt-in flags.
   2.3 Create REST handlers:
        - `POST /api/notifications/subscriptions` → register/update subscription.
        - `DELETE /api/notifications/subscriptions` → unsubscribe (body or query param for endpoint).
        - Guard with `requireAuth`; validate payload via Zod DTO.
   2.4 Build service worker bundle (`public/sw-push.js` or similar) to listen for push events, display notifications, and handle click actions.
   2.5 Add server-side push helper that queues notifications (interface for eventually using worker/cron).
   Deliverable: Push subscription lifecycle functioning in dev; smoke scenarios documented.

3. Client Subscription UX (H) — ✅ Completed Feb 2025
   3.1 Implement UI component (e.g., `components/notifications/PushOptInCard.tsx`) for subscribe/unsubscribe, permission state, and troubleshooting tips.
   3.2 Integrate opt-in UI on `/notifications` page and add CTA in profile settings.
   3.3 Handle permission prompts gracefully (respect denied state, show instructions).
   3.4 Log user interactions for analytics (optional but recommended).
   Deliverable: End-to-end subscribe/unsubscribe from UI with feedback.

4. Trigger Push Notifications for Key Events (H) — ✅ Completed Feb 2025
   4.1 Update challenge creation/acceptance flows to enqueue push events.
   4.2 Add streak-change hooks in gamification service to trigger push.
   4.3 Ensure duplicate suppression (e.g., do not send push + in-app duplicates within short TTL).
   4.4 Record delivery status in notification entity for audit.
   Deliverable: Push notifications reliably emitted for challenge/streak events; verified via staging tests.

5. Email Digest System (H) — ✅ Completed Feb 2025
   5.1 Extend user notification preferences (Prisma model) with digest frequency (`OFF`, `DAILY`, `WEEKLY`).
   5.2 Create digest template (MJML or JSX) summarizing pending challenges, streak reminders, recent badges.
   5.3 Add background job (e.g., scheduled script or queue worker) to generate digest per user per cadence.
   5.4 Integrate with email provider SDK; include unsubscribe link pointing to profile settings.
   5.5 Add admin override in case of emergency disable.
   Deliverable: Digest emails sending in staging; sample stored in `docs/samples/email-digest.html`.

6. Notification Delivery Abstraction (M) — ✅ Completed Feb 2025
   6.1 Refactor `lib/services/notification.service.ts` to route via channel adapters (in-app, push, email).
   6.2 Implement retry/backoff with logging for failed push/email sends.
   6.3 Standardize payload schema to ensure consistent titles, copy, deep links.
   Deliverable: Unified notification service with channel-specific adapters and tests.

7. Testing & QA (M) — ✅ Completed Feb 2025
   7.1 Unit tests for subscription endpoints, notification service, digest job.
   7.2 Browser matrix manual QA (Chrome, Firefox, Safari desktop/mobile) covering opt-in/out and push display.
   7.3 Integration tests for challenge/campaign flows verifying push/email queue entries.
   7.4 Update smoke scripts to include subscription endpoints (optional if automation ready).
   Deliverable: Test checklist logged in `docs/qa/notifications-push-checklist.md`.

8. Documentation & Runbooks (L)
   8.1 Create `docs/NOTIFICATIONS_PUSH.md` covering setup, env vars, deployment caveats.
   8.2 Update `docs/LATEST_UPDATES.md` with feature release notes.
   8.3 Add runbook entry for troubleshooting push/email failures (alert escalation, manual resend).
   Deliverable: Documentation merged and referenced in README.

9. Rollout & Monitoring (L)
   9.1 Enable feature flag `NOTIFICATIONS_PUSH_ENABLED=true` in staging and verify push + digests end-to-end.
   9.2 Configure Vercel cron (daily + weekly) to invoke digest script or queue worker.
   9.3 Wire Logflare + Sentry dashboards (push latency, digest failures) and share links with on-call.
   9.4 Gradually roll out to 5%/25%/100% of users, monitoring opt-in conversion and error rates for 48h at each step.
   9.5 Capture user feedback, adjust copy, and publish final release notes.
   Deliverable: Feature flag enabled in production with monitoring dashboards confirmed.

Execution Notes
---------------
- Keep plan updated as tasks complete; reference this file in PRs and stand-ups.
- Coordinate with middleware changes to ensure auth guards and request context remain consistent.
- Ensure compliance with privacy regulations; always allow easy opt-out.
